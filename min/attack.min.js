function attack(I,e,c){var f=I.attr("data-attack-roll");var r=1;var u=false;if(typeof f!=="undefined"&&f.indexOf("[")!=-1){r=(""+$.parseJSON(f)).split(",").length;u=1}f=typeof f!=="undefined"&&f!==false;for(var v=0;v<r;v++){var H=I.attr("data-roll");if(H.indexOf("[")!=-1){H=$.parseJSON(H)[v];H=JSON.stringify(H)}var L=I.attr("data-spatk");if(L&&typeof L!=="undefined"){if(L.indexOf("[")!=-1){L=L.substring(1,L.length-1);L=L.split(",");L=L[v]}L=L.trim()}var F=I.attr("data-roll-for");if(F&&typeof F!=="undefined"){if(F.indexOf(",")!=-1){F=F.split(",");F=F[v]}F=F.trim()}var D=e.closest("div[data-for]").attr("id");var l=$("a[href='#"+D+"']").html();var k=I.attr("data-how-many");if(typeof k!=="undefined"&&k.indexOf("[")!=-1){k=k.substring(1,k.length-1);k=k.split(",");k=k[v]}k=parseInt(k)||1;var o=I.attr("data-range");if(typeof o!=="undefined"&&o.indexOf("[")!=-1){o=o.substring(1,o.length-1);o=o.split(",");o=o[v]}o=o!="0";var G=I.attr("data-min-crit");if(typeof G!=="undefined"&&G.indexOf("[")!=-1){G=G.substring(1,G.length-1);G=G.split(",");G=G[v]}G=parseInt(G);var g=H.indexOf("(2h)")!=-1;var s=I.attr("data-attack-roll");if(typeof s!=="undefined"&&s.indexOf("[")!=-1){s=$.parseJSON(s)[v];s=JSON.stringify(s)}var B=I.attr("data-bab-use");if(typeof B!=="undefined"&&B.indexOf("[")!=-1){B=B.substring(1,B.length-1);B=B.split(",");B=B[v]}var E=I.attr("data-secondary");if(typeof E!=="undefined"&&E.indexOf("[")!=-1){E=E.substring(1,E.length-1);E=E.split(",");E=parseInt(E[v])}var C=1;var b=parseInt($("#"+c+"_bab").text());var p=0;var a=Math.floor(b/5);for(var w=0;w<k;w++){C=1;var j=0;var h="";var z="";var K=u&&a>1?"("+(w+1)+"/"+a+") ":"";if(u&&B=="1"){if(E){if((hasFeat(c,"Greater Two-Weapon Fighting")||hasFeat(c,"Greater Multiweapon Fighting"))&&p==1){p++;p++;if(b>5){b-=5;k++}}if((hasFeat(c,"Improved Two-Weapon Fighting")||hasFeat(c,"Improved Multiweapon Fighting"))&&p==0){p++;if(b>5){b-=5;k++}}}else{p++;if(b>5){b-=5;k++}}}if(f){var d=_buildRoll(c,s,true,o,false);if(p>1){d["Attack "+(p)]=-(p-1)*5}for(var J in d){if(d[J]==0){continue}j+=d[J];h+=J+": "+d[J]+"<br>";z=_critStatus(d[J],J,G,true)||z;if(z=="threat"||z=="success"){var y=_buildRoll(c,s,true,o,false);if(p>1){y["Attack "+(p)]=-(p-1)*5}var n=0,t="";for(var A=0;A<C;A++){var m=_buildRoll(c,H,false,o,f);if(g&&m["Power Attack"]!==undefined){m["Power Attack"]*=2}if(p>1){m["Attack "+(p)]=-(p-1)*5}for(var J in m){if(m[J]==0){continue}n+=m[J];t+=J+": "+m[J]+"<br>"}}C=I.attr("data-crit-mult");if(typeof C!=="undefined"&&C.indexOf("[")!=-1){C=C.substring(1,C.length-1);C=C.split(",");C=C[v]}C=parseInt(C);y=_rollArray(y);m=_rollArray(m)}}if(z=="threat"||z=="success"){addToLog(K+logMessages.critAttempt(l,F,h,j),z,D);addToLog(K+logMessages.critMiss(l,F,t,n)+(L!=null&&L!="null"?" ("+L+" occurs)":""),z,D);addToLog(K+logMessages.critSecond(l,F,y.text,y.result),z,D)}else{addToLog(K+logMessages.initiate(l,F,h,j),z,D)}}j=0;h="";for(var A=0;A<C;A++){var q=_buildRoll(c,H,false,o,f);if(g&&q["Power Attack"]!==undefined){q["Power Attack"]*=2}for(var J in q){if(q[J]==0){continue}j+=q[J];h+=J+": "+q[J]+"<br>";z=_critStatus(q[J],J,0,false)||z}}if((z=="threat"||z=="success")&&f){addToLog(K+logMessages.critSuccess(l,F,h,j)+(L!=null&&L!="null"?" ("+L+" occurs)":""),z,D)}else{if(f){addToLog(K+logMessages.hit(l,F,h,j)+(L!=null&&L!="null"?" ("+L+" occurs)":""),z,D)}else{addToLog(K+logMessages.skill(l,F,h,j),z,D)}}}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0||a[c]==null){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};