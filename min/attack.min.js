function attack(h,r,n){var j=h.attr("data-attack-roll");var E=1;var v=false;if(typeof j!=="undefined"&&j.indexOf("[")!=-1){E=(""+$.parseJSON(j)).split(",").length;v=1}j=typeof j!=="undefined"&&j!==false;for(var g=0;g<E;g++){var c=h.attr("data-roll");if(c.indexOf("[")!=-1){c=$.parseJSON(c)[g];c=JSON.stringify(c)}var y=h.attr("data-spatk");if(y&&typeof y!=="undefined"){if(y.indexOf("[")!=-1){y=y.substring(1,y.length-1);y=y.split(",");y=y[g]}y=y.trim()}var p=h.attr("data-roll-for");if(p&&typeof p!=="undefined"){if(p.indexOf(",")!=-1){p=p.split(",");p=p[g]}p=p.trim()}var B=r.closest("div[data-for]").attr("id");var w=$("a[href='#"+B+"']").html();var f=h.attr("data-how-many");if(typeof f!=="undefined"&&f.indexOf("[")!=-1){f=f.substring(1,f.length-1);f=f.split(",");f=f[g]}f=parseInt(f)||1;var F=h.attr("data-range");if(typeof F!=="undefined"&&F.indexOf("[")!=-1){F=F.substring(1,F.length-1);F=F.split(",");F=F[g]}F=F!="0";var l=h.attr("data-min-crit");if(typeof l!=="undefined"&&l.indexOf("[")!=-1){l=l.substring(1,l.length-1);l=l.split(",");l=l[g]}l=parseInt(l);var b=c.indexOf("(2h)")!=-1;var C=h.attr("data-attack-roll");if(typeof C!=="undefined"&&C.indexOf("[")!=-1){C=$.parseJSON(C)[g];C=JSON.stringify(C)}var a=h.attr("data-bab-use");if(typeof a!=="undefined"&&a.indexOf("[")!=-1){a=a.substring(1,a.length-1);a=a.split(",");a=a[g]}var G=parseInt($("#"+n+"_bab").text());var e=0;for(var u=0;u<f;u++){var s=0;var z="";var k=1;var o="";if(v&&a=="1"){e++;if(G>5){G-=5;f++}}if(j){var m=_buildRoll(n,C,true,F,false);if(e>1){m["Attack "+(e)]=-(e-1)*5}for(var A in m){if(m[A]==0){continue}s+=m[A];z+=A+": "+m[A]+"<br>";o=_critStatus(m[A],A,l,true)||o;if(o=="threat"||o=="success"){var t=_buildRoll(n,C,true,F,false);if(e>1){t["Attack "+(e)]=-(e-1)*5}var d=_buildRoll(n,C,true,F,false);if(e>1){d["Attack "+(e)]=-(e-1)*5}t=_rollArray(t);d=_rollArray(d);k=h.attr("data-crit-mult");if(typeof k!=="undefined"&&k.indexOf("[")!=-1){k=k.substring(1,k.length-1);k=k.split(",");k=k[g]}k=parseInt(k)}}if(o=="threat"||o=="success"){addToLog(logMessages.critAttempt(w,p,z,s),o,B);addToLog(logMessages.critMiss(w,p,d.text,d.result)+(y!=null&&y!="null"?" ("+y+" occurs)":""),o,B);addToLog(logMessages.critSecond(w,p,t.text,t.result),o,B)}else{addToLog(logMessages.initiate(w,p,z,s),o,B)}}s=0;z="";for(var q=0;q<k;q++){var D=_buildRoll(n,c,false,F,j);if(b&&D["Power Attack"]!==undefined){D["Power Attack"]*=2}for(var A in D){if(D[A]==0){continue}s+=D[A];z+=A+": "+D[A]+"<br>";o=_critStatus(D[A],A,0,false)||o}}console.log("test: "+k+" "+c);if((o=="threat"||o=="success")&&j){addToLog(logMessages.critSuccess(w,p,z,s)+(y!=null&&y!="null"?" ("+y+" occurs)":""),o,B)}else{if(j){addToLog(logMessages.hit(w,p,z,s)+(y!=null&&y!="null"?" ("+y+" occurs)":""),o,B)}else{addToLog(logMessages.skill(w,p,z,s),o,B)}}}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};