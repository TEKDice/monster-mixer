function attack(j,s,o){var k=j.attr("data-attack-roll");var H=1;var z=false;if(typeof k!=="undefined"&&k.indexOf("[")!=-1){H=(""+$.parseJSON(k)).split(",").length;z=1}k=typeof k!=="undefined"&&k!==false;for(var h=0;h<H;h++){var d=j.attr("data-roll");if(d.indexOf("[")!=-1){d=$.parseJSON(d)[h];d=JSON.stringify(d)}var B=j.attr("data-spatk");if(B&&typeof B!=="undefined"){if(B.indexOf("[")!=-1){B=B.substring(1,B.length-1);B=B.split(",");B=B[h]}B=B.trim()}var q=j.attr("data-roll-for");if(q&&typeof q!=="undefined"){if(q.indexOf(",")!=-1){q=q.split(",");q=q[h]}q=q.trim()}var E=s.closest("div[data-for]").attr("id");var A=$("a[href='#"+E+"']").html();var g=j.attr("data-how-many");if(typeof g!=="undefined"&&g.indexOf("[")!=-1){g=g.substring(1,g.length-1);g=g.split(",");g=g[h]}g=parseInt(g)||1;var J=j.attr("data-range");if(typeof J!=="undefined"&&J.indexOf("[")!=-1){J=J.substring(1,J.length-1);J=J.split(",");J=J[h]}J=J!="0";var m=j.attr("data-min-crit");if(typeof m!=="undefined"&&m.indexOf("[")!=-1){m=m.substring(1,m.length-1);m=m.split(",");m=m[h]}m=parseInt(m);var b=d.indexOf("(2h)")!=-1;var F=j.attr("data-attack-roll");if(typeof F!=="undefined"&&F.indexOf("[")!=-1){F=$.parseJSON(F)[h];F=JSON.stringify(F)}var a=j.attr("data-bab-use");if(typeof a!=="undefined"&&a.indexOf("[")!=-1){a=a.substring(1,a.length-1);a=a.split(",");a=a[h]}var l=1;var K=parseInt($("#"+o+"_bab").text());var f=0;var w=Math.floor(K/5);for(var y=0;y<g;y++){l=1;var t=0;var C="";var p="";var v=z&&w>1?"("+(y+1)+"/"+w+") ":"";if(z&&a=="1"){f++;if(K>5){K-=5;g++}}if(k){var n=_buildRoll(o,F,true,J,false);if(f>1){n["Attack "+(f)]=-(f-1)*5}for(var D in n){if(n[D]==0){continue}t+=n[D];C+=D+": "+n[D]+"<br>";p=_critStatus(n[D],D,m,true)||p;if(p=="threat"||p=="success"){var u=_buildRoll(o,F,true,J,false);if(f>1){u["Attack "+(f)]=-(f-1)*5}var c=0,I="";for(var r=0;r<l;r++){var e=_buildRoll(o,d,false,J,k);if(b&&e["Power Attack"]!==undefined){e["Power Attack"]*=2}if(f>1){e["Attack "+(f)]=-(f-1)*5}for(var D in e){if(e[D]==0){continue}c+=e[D];I+=D+": "+e[D]+"<br>"}}l=j.attr("data-crit-mult");if(typeof l!=="undefined"&&l.indexOf("[")!=-1){l=l.substring(1,l.length-1);l=l.split(",");l=l[h]}l=parseInt(l);u=_rollArray(u);e=_rollArray(e)}}if(p=="threat"||p=="success"){addToLog(v+logMessages.critAttempt(A,q,C,t),p,E);addToLog(v+logMessages.critMiss(A,q,I,c)+(B!=null&&B!="null"?" ("+B+" occurs)":""),p,E);addToLog(v+logMessages.critSecond(A,q,u.text,u.result),p,E)}else{addToLog(v+logMessages.initiate(A,q,C,t),p,E)}}t=0;C="";for(var r=0;r<l;r++){var G=_buildRoll(o,d,false,J,k);if(b&&G["Power Attack"]!==undefined){G["Power Attack"]*=2}for(var D in G){if(G[D]==0){continue}t+=G[D];C+=D+": "+G[D]+"<br>";p=_critStatus(G[D],D,0,false)||p}}if((p=="threat"||p=="success")&&k){addToLog(v+logMessages.critSuccess(A,q,C,t)+(B!=null&&B!="null"?" ("+B+" occurs)":""),p,E)}else{if(k){addToLog(v+logMessages.hit(A,q,C,t)+(B!=null&&B!="null"?" ("+B+" occurs)":""),p,E)}else{addToLog(v+logMessages.skill(A,q,C,t),p,E)}}}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};