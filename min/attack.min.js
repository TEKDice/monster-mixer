function attack(h,r,n){var j=h.attr("data-attack-roll");var F=1;var w=false;if(typeof j!=="undefined"&&j.indexOf("[")!=-1){F=(""+$.parseJSON(j)).split(",").length;w=1}j=typeof j!=="undefined"&&j!==false;for(var g=0;g<F;g++){var c=h.attr("data-roll");if(c.indexOf("[")!=-1){c=$.parseJSON(c)[g];c=JSON.stringify(c)}var z=h.attr("data-spatk");if(z&&typeof z!=="undefined"){if(z.indexOf("[")!=-1){z=z.substring(1,z.length-1);z=z.split(",");z=z[g]}z=z.trim()}var p=h.attr("data-roll-for");if(p&&typeof p!=="undefined"){if(p.indexOf(",")!=-1){p=p.split(",");p=p[g]}p=p.trim()}var C=r.closest("div[data-for]").attr("id");var y=$("a[href='#"+C+"']").html();var f=h.attr("data-how-many");if(typeof f!=="undefined"&&f.indexOf("[")!=-1){f=f.substring(1,f.length-1);f=f.split(",");f=f[g]}f=parseInt(f)||1;var G=h.attr("data-range");if(typeof G!=="undefined"&&G.indexOf("[")!=-1){G=G.substring(1,G.length-1);G=G.split(",");G=G[g]}G=G!="0";var l=h.attr("data-min-crit");if(typeof l!=="undefined"&&l.indexOf("[")!=-1){l=l.substring(1,l.length-1);l=l.split(",");l=l[g]}l=parseInt(l);var b=c.indexOf("(2h)")!=-1;var D=h.attr("data-attack-roll");if(typeof D!=="undefined"&&D.indexOf("[")!=-1){D=$.parseJSON(D)[g];D=JSON.stringify(D)}var a=h.attr("data-bab-use");if(typeof a!=="undefined"&&a.indexOf("[")!=-1){a=a.substring(1,a.length-1);a=a.split(",");a=a[g]}var H=parseInt($("#"+n+"_bab").text());var e=0;for(var v=0;v<f;v++){var s=0;var A="";var k=1;var o="";var u=f>1?"("+(v+1)+"/"+f+") ":"";if(w&&a=="1"){e++;if(H>5){H-=5;f++}}if(j){var m=_buildRoll(n,D,true,G,false);if(e>1){m["Attack "+(e)]=-(e-1)*5}for(var B in m){if(m[B]==0){continue}s+=m[B];A+=B+": "+m[B]+"<br>";o=_critStatus(m[B],B,l,true)||o;if(o=="threat"||o=="success"){var t=_buildRoll(n,D,true,G,false);if(e>1){t["Attack "+(e)]=-(e-1)*5}var d=_buildRoll(n,D,true,G,false);if(e>1){d["Attack "+(e)]=-(e-1)*5}t=_rollArray(t);d=_rollArray(d);k=h.attr("data-crit-mult");if(typeof k!=="undefined"&&k.indexOf("[")!=-1){k=k.substring(1,k.length-1);k=k.split(",");k=k[g]}k=parseInt(k)}}if(o=="threat"||o=="success"){addToLog(u+logMessages.critAttempt(y,p,A,s),o,C);addToLog(u+logMessages.critMiss(y,p,d.text,d.result)+(z!=null&&z!="null"?" ("+z+" occurs)":""),o,C);addToLog(u+logMessages.critSecond(y,p,t.text,t.result),o,C)}else{addToLog(u+logMessages.initiate(y,p,A,s),o,C)}}s=0;A="";for(var q=0;q<k;q++){var E=_buildRoll(n,c,false,G,j);if(b&&E["Power Attack"]!==undefined){E["Power Attack"]*=2}for(var B in E){if(E[B]==0){continue}s+=E[B];A+=B+": "+E[B]+"<br>";o=_critStatus(E[B],B,0,false)||o}}if((o=="threat"||o=="success")&&j){addToLog(u+logMessages.critSuccess(y,p,A,s)+(z!=null&&z!="null"?" ("+z+" occurs)":""),o,C)}else{if(j){addToLog(u+logMessages.hit(y,p,A,s)+(z!=null&&z!="null"?" ("+z+" occurs)":""),o,C)}else{addToLog(u+logMessages.skill(y,p,A,s),o,C)}}}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};