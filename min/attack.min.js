function doAttack(l,d,g,A,o,D,f,H,j,E,a,y,m,r){if(A){A=A.trim()}if(o){o=o.trim()}var z=$("a[href='#"+D+"']").html();var b=d.indexOf("(2h)")!=-1;var h=1;var v=m!=null?m:f;for(var w=0;w<f;w++){var p=r!=null?r:w;h=1;var s=0;var B="";var n="";var u=v>1?"("+(r+1)+"/"+v+") ":"";if(g){var k=_buildRoll(l,E,true,H,false);for(var C in k){if(k[C]==0){continue}s+=k[C];B+=C+": "+k[C]+"<br>";n=_critStatus(k[C],C,j,true)||n;if(n=="threat"||n=="success"){var t=_buildRoll(l,E,true,H,false);var c=0,G="";var e=_buildRoll(l,d,false,H,g);if(b&&e["Power Attack"]!==undefined){e["Power Attack"]*=2}for(var C in e){if(e[C]==0){continue}c+=e[C];G+=C+": "+e[C]+"<br>"}h=a||1;t=_rollArray(t);e=_rollArray(e)}}if(n=="threat"||n=="success"){addToLog(u+logMessages.critAttempt(z,o,B,s),n,D);addToLog(u+logMessages.critMiss(z,o,G,c)+(A!=null&&A!="null"?" ("+A+" occurs)":""),n,D);addToLog(u+logMessages.critSecond(z,o,t.text,t.result),n,D)}else{addToLog(u+logMessages.initiate(z,o,B,s),n,D)}}s=0;B="";for(var q=0;q<h;q++){var F=_buildRoll(l,d,false,H,g);if(b&&F["Power Attack"]!==undefined){F["Power Attack"]*=2}for(var C in F){if(F[C]==0){continue}s+=F[C];B+=C+": "+F[C]+"<br>";n=_critStatus(F[C],C,0,false)||n}}if((n=="threat"||n=="success")&&g){addToLog(u+logMessages.critSuccess(z,o,B,s)+(A!=null&&A!="null"?" ("+A+" occurs)":""),n,D)}else{if(g){addToLog(u+logMessages.hit(z,o,B,s)+(A!=null&&A!="null"?" ("+A+" occurs)":""),n,D)}else{addToLog(u+logMessages.skill(z,o,B,s),n,D)}}}}function attack(e,k,h){var l=typeof e.attr("data-fatk")!=="undefined";var b=e.attr("data-roll");var m=e.attr("data-spatk");var j=e.attr("data-roll-for");var o=k.closest("div[data-for]").attr("id");var f=e.attr("data-attack-roll");f=typeof f!=="undefined"&&f!==false;var c=parseInt(e.attr("data-how-many"))||1;var s=e.attr("data-range")!="0";var g=parseInt(e.attr("data-min-crit"));var q=e.attr("data-attack-roll");var d=parseInt(e.attr("data-crit-mult"));if(l){var a=$.parseJSON(e.attr("data-fatk"));s=a.range!="0";$.each(a.rolls,function(w,u){var v=u.refIndex;doAttack(h,JSON.stringify(u.tohit),true,a.spatk[v],a.names[v],o,1,s,a.minCrit[v],JSON.stringify(u.damage),a.critMult[v],true,a.rolls.length,w)})}else{var t=parseInt($("#"+h+"_bab").text());var p=Math.max(Math.floor(t/5)+1,1);for(var n=0;n<p;n++){var r=$.parseJSON(q);if(n>0){r["Attack "+(n+1)]=-(n)*5}q=JSON.stringify(r);doAttack(h,b,f,m,j,o,c,s,g,q,d,false,p,n)}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0||a[c]==null){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};