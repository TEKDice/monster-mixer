function attack(j,s,o){var k=j.attr("data-attack-roll");var G=1;var y=false;if(typeof k!=="undefined"&&k.indexOf("[")!=-1){G=(""+$.parseJSON(k)).split(",").length;y=1}k=typeof k!=="undefined"&&k!==false;for(var h=0;h<G;h++){var d=j.attr("data-roll");if(d.indexOf("[")!=-1){d=$.parseJSON(d)[h];d=JSON.stringify(d)}var A=j.attr("data-spatk");if(A&&typeof A!=="undefined"){if(A.indexOf("[")!=-1){A=A.substring(1,A.length-1);A=A.split(",");A=A[h]}A=A.trim()}var q=j.attr("data-roll-for");if(q&&typeof q!=="undefined"){if(q.indexOf(",")!=-1){q=q.split(",");q=q[h]}q=q.trim()}var D=s.closest("div[data-for]").attr("id");var z=$("a[href='#"+D+"']").html();var g=j.attr("data-how-many");if(typeof g!=="undefined"&&g.indexOf("[")!=-1){g=g.substring(1,g.length-1);g=g.split(",");g=g[h]}g=parseInt(g)||1;var I=j.attr("data-range");if(typeof I!=="undefined"&&I.indexOf("[")!=-1){I=I.substring(1,I.length-1);I=I.split(",");I=I[h]}I=I!="0";var m=j.attr("data-min-crit");if(typeof m!=="undefined"&&m.indexOf("[")!=-1){m=m.substring(1,m.length-1);m=m.split(",");m=m[h]}m=parseInt(m);var b=d.indexOf("(2h)")!=-1;var E=j.attr("data-attack-roll");if(typeof E!=="undefined"&&E.indexOf("[")!=-1){E=$.parseJSON(E)[h];E=JSON.stringify(E)}var a=j.attr("data-bab-use");if(typeof a!=="undefined"&&a.indexOf("[")!=-1){a=a.substring(1,a.length-1);a=a.split(",");a=a[h]}var l=1;l=j.attr("data-crit-mult");if(typeof l!=="undefined"&&l.indexOf("[")!=-1){l=l.substring(1,l.length-1);l=l.split(",");l=l[h]}l=parseInt(l);var J=parseInt($("#"+o+"_bab").text());var f=0;for(var w=0;w<g;w++){var t=0;var B="";var p="";var v=g>1?"("+(w+1)+"/"+g+") ":"";if(y&&a=="1"){f++;if(J>5){J-=5;g++}}if(k){var n=_buildRoll(o,E,true,I,false);if(f>1){n["Attack "+(f)]=-(f-1)*5}for(var C in n){if(n[C]==0){continue}t+=n[C];B+=C+": "+n[C]+"<br>";p=_critStatus(n[C],C,m,true)||p;if(p=="threat"||p=="success"){var u=_buildRoll(o,E,true,I,false);if(f>1){u["Attack "+(f)]=-(f-1)*5}var c=0,H="";for(var r=0;r<l;r++){var e=_buildRoll(o,d,false,I,k);if(b&&e["Power Attack"]!==undefined){e["Power Attack"]*=2}if(f>1){e["Attack "+(f)]=-(f-1)*5}for(var C in e){if(e[C]==0){continue}c+=e[C];H+=C+": "+e[C]+"<br>"}}u=_rollArray(u);e=_rollArray(e)}}if(p=="threat"||p=="success"){addToLog(v+logMessages.critAttempt(z,q,B,t),p,D);addToLog(v+logMessages.critMiss(z,q,H,c)+(A!=null&&A!="null"?" ("+A+" occurs)":""),p,D);addToLog(v+logMessages.critSecond(z,q,u.text,u.result),p,D)}else{addToLog(v+logMessages.initiate(z,q,B,t),p,D)}}t=0;B="";for(var r=0;r<l;r++){var F=_buildRoll(o,d,false,I,k);if(b&&F["Power Attack"]!==undefined){F["Power Attack"]*=2}for(var C in F){if(F[C]==0){continue}t+=F[C];B+=C+": "+F[C]+"<br>";p=_critStatus(F[C],C,0,false)||p}}if((p=="threat"||p=="success")&&k){addToLog(v+logMessages.critSuccess(z,q,B,t)+(A!=null&&A!="null"?" ("+A+" occurs)":""),p,D)}else{if(k){addToLog(v+logMessages.hit(z,q,B,t)+(A!=null&&A!="null"?" ("+A+" occurs)":""),p,D)}else{addToLog(v+logMessages.skill(z,q,B,t),p,D)}}}}}function _critStatus(b,c,e,a){var d;if(b<=1&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="fail"}else{if(a&&(b>=e&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1)){d="threat";if(b>=20){d="success"}}else{if(b>=20&&c.indexOf("1d20")!=-1&&c.indexOf("Base")!=-1){d="success"}}}return d}function _buildRoll(d,c,f,b,a){var e=rollDice(c);if(f){if(hasFeat(d,"Combat Expertise")){var g=parseInt($("#"+d+"_calc_ce").children("input").val());if(g!=0&&!isNaN(g)){e["Combat Expertise"]=-g}}if(hasFeat(d,"Awesome Blow")&&$("#"+d+"_calc_ab").is(":checked")){e["Awesome Blow"]=-4}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){e["Point Blank Shot"]=1}if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=-g}}}if(a){if(hasFeat(d,"Power Attack")){var g=parseInt($("#"+d+"_calc_pa").children("input").val());if(g!=0&&!isNaN(g)){e["Power Attack"]=g}}if(hasFeat(d,"Point Blank Shot")&&$("#"+d+"_calc_pbs").is(":checked")&&b){c["Point Blank Shot"]=1}}return e}function _rollArray(a){var b={result:0,text:""};for(var c in a){if(a[c]==0){continue}b.result+=a[c];b.text+=c+": "+a[c]+"<br>"}return b};