function overlayLoadingGif(){$t=$("#monsterListCont");if(!$t.length){return}$("#overlay").css({opacity:0.8,top:$t.offset().top,left:$t.offset().left,width:$t.outerWidth(),height:$t.outerHeight()});$("#img-load").css({top:($t.height()/2),left:($t.width()/2)})}function rollDice(d){var a;try{var c=$.parseJSON(d);a=[];$.each(c,function(f,g){if(f=="Base"){f="Base ("+g+")"}if(typeof g=="string"&&g.indexOf("d")!=-1){a[f]=parseInt(rollExpression(g))}else{a[f]=isNaN(parseInt(g))?0:parseInt(g)}})}catch(b){a=rollExpression(d)}if(a===undefined){bootbox.alert("The roll '"+d+"'' is invalid.");return null}return a}function determineRoll(a){if(a.hasClass("roll_me")){var b=rollExpression(a.attr("data-base-value"));a.attr("data-initial-roll",b)}}function get_bonus(a){a=parseInt(a);if(a==0||isNaN(a)){return 0}return Math.floor(a/2)-5}function _cleanName(a){return a.split(" ").join("")}function bodyBinding(){$("body").on("click",".reroll-hp",function(){var c=$(this).attr("data-uid");var b=$(this).closest("span[data-attr='hit_dice']");var a=rollExpression(b.attr("data-base-value"));rollHp(c,b,a)});$("body").on("click",".left",function(){var a=$("#monsterList").children(".active");var b;if(a.is($("#monsterList").children().first())){b=$("#monsterList").children().last()}else{b=$("#monsterList").children(".active").prev()}b.children("a").tab("show")});$("body").on("click",".right",function(){var a=$("#monsterList").children(".active");var b;if(a.is($("#monsterList").children().last())){b=$("#monsterList").children().first()}else{b=$("#monsterList").children(".active").next()}b.children("a").tab("show")});$(".loaded").livequery(function(){var a=$(this).closest(".minibox-content").find("tr[data-roll]:not(.unrollable)");a.each(function(){$(this).click(function(){a.removeClass("info");if($(this).hasClass("info")){$(this).removeClass("info")}else{$(this).addClass("info")}})})});$(".delete").livequery(function(){$(this).click(function(){var b=$(this).attr("data-uid");var a=$("#"+b+"_name").text();bootbox.confirm("Are you sure you want to remove "+a+" from the encounter?",function(c){if(c){remove(b,false)}})})})}function collect(){var b={};var a=arguments.length;for(var c=0;c<a;c++){for(p in arguments[c]){if(arguments[c].hasOwnProperty(p)){b[p]=arguments[c][p]}}}return b}function clamp(c,a,b){b=Math.max(c,b);b=Math.min(a,b);return b}var defaultFunction=function(){return"THIS IS AN ERROR"};var formatting={madvanc:defaultFunction,malign:defaultFunction,marmor:function(a){return a.aname+(a.enchantment_bonus!="0"?" +"+a.enchantment_bonus:"")},mattack:function(a){return a.aname+"</td><td>"+(a.hitdc!="0"?a.hitdc:"")+"</td><td class='rightalign'>"+(a.dmgname!=null?"+"+a.dmgred_hd+" "+a.dmgname:"")},mdmgred:function(a){return a.name+"</td><td>"+(a.reduction_amount=="0"?"Immune":a.reduction_amount)},mfeat:function(a){return a.name+(a.feat_level>1?" (x"+a.feat_level+")":"")+"</td><td>"+(a.name=="Power Attack"||a.name=="Combat Expertise"?'<input class="input-mini-inline applyNum" type="number" placeholder="#"></input>':"")+(a.name=="Awesome Blow"||a.name=="Point Blank Shot"?'<input class="inline-checkbox" type="checkbox"></input>':"")+"</td>"},mfatk:function(b){var a=[];$.each(b,function(c,d){if(d.wname){a.push(d.wname)}if(d.atkname){a.push(d.atkname)}});return a.join(", ")},mlang:defaultFunction,mmove:function(a){return a.movement_type+"</td><td>"+a.movement_speed+"ft"},morgani:defaultFunction,mqualit:function(a){return a.name+"</td><td>"+(a.value!="0"?a.value+(a.name!="Spell Resistance"&&a.name!="Regeneration"&&a.name!="Turn Resistance"?"ft":""):"")},mskill:function(a){return a.name+(a.sub_skill!=""&&a.sub_skill!=null?" ("+a.sub_skill+")":"")+"</td><td>"+(parseInt(a.skill_level)<0?a.skill_level:"+"+a.skill_level)},mspatk:function(a){return a.name+"</td><td>"+(a.range!="0"?a.range+"ft":"")+"</td><td class='rightalign'>"+(a.hit_dice!="0"?a.hit_dice:"")+" "+(a.dmgred_hd!="0"&&a.dmgred_hd!=null?"+"+a.dmgred_hd+" "+a.dmgred_nm:"")},msubcat:defaultFunction,mterr:defaultFunction,mtype:defaultFunction,mweapon:function(a){return a.extra_wsize+" "+a.wname+(a.enchantment_bonus!="0"?" +"+a.enchantment_bonus:"")+"</td><td>"+a.hitdc+"</td><td class='rightalign'>"+(a.dmgname!=null?"+"+a.dmgred_hd+" "+a.dmgname:"")}};function hasWeaponFocus(d,c){if(hasFeat(c,"Weapon Focus")){var b=fullFeatName(c,"Weapon Focus");var a=b.substring(b.indexOf("(")+1,b.indexOf(")"));if(d.aname!=undefined){if(a.toLowerCase()==d.aname.toLowerCase()){return true}}if(d.wname!=undefined){if(a.toLowerCase()==d.wname.toLowerCase()){return true}}}return false}var rollable={mfatk:function(c,b){var a=[];$.each(c,function(h,j){var d={};if(j.atkhd){var g=rollable.mattack(j,b);var f=$.parseJSON(g);d=collect(d,f)}if(j.wname){j.mfa_strict=j.mfa_strict=="0"?"1":"0";var g=rollable.mweapon(j,b,j.wir||j.mfa_range,j.mfa_strict);var f=$.parseJSON(g);d=collect(d,f)}a.push(d)});return JSON.stringify(a)},mattack:function(d,c){var b={};b.Base=d.hitdc;if(d.dmgname!=null){b[d.dmgname+" ("+d.dmgred_hd+")"]=d.dmgred_hd}var a=get_bonus(parseInt($("#"+c+"_str").attr("data-base-value")));b["STR Mod"]=Math.floor(a*parseFloat(d.max_str_mod));return JSON.stringify(b)},mskill:function(c,b){var a={};a.Base="1d20";a.Bonus=c.skill_level;return JSON.stringify(a)},mweapon:function(f,d,b,e){var c={};c.Base=f.hitdc;if(f.dmgname!=null){c[f.dmgname+" ("+f.dmgred_hd+")"]=f.dmgred_hd}var a=get_bonus(parseInt($("#"+d+"_str").attr("data-base-value")));var g=parseFloat(f.max_str_mod)||0;if(e=="1"){if(f.is_uses_str_mod=="1"){if(f.is_one_handed=="0"){if(a!=0){c["STR Mod (2h)"]=(a>g&&g!=0?g:a)*1.5}}else{if(a!=0){c["STR Mod"]=a>g&&g!=0?g*a:a}}}}else{if(f.wname.toLowerCase().indexOf("composite")!=-1){c["STR Mod"]=clamp(0,g,a)}if(a<0&&f.wname.toLowerCase().indexOf("crossbow")==-1){c["STR Mod"]=a}}return JSON.stringify(c)},mspatk:function(d,c){var b={};if(d.hit_dice!="0"){b.Base=d.hit_dice}if(d.dmgred_hd!="0"){b[d.dmgred_nm]=d.dmgred_hd}var a=get_bonus(parseInt($("#"+c+"_str").attr("data-base-value")))*parseFloat(d.max_str_mod);if(a!=0){b["STR Mod"]=a}return JSON.stringify(b)}};var attackRolls={mfatk:function(e,d,a){var b=[];var c=[];$.each(e,function(k,l){var g={};if(l.atkhd){var j=attackRolls.mattack(l,d);var h=$.parseJSON(j);g=collect(g,h);if(parseFloat(l.mfa_class_mult)==0.5){if(hasFeat(d,"Multiattack")){g["Secondary Penalty"]=-2}else{g["Secondary Penalty"]=-5}}l.wlight="1";l.mfa_class_mult=="0.50"}if(l.wname){var j=attackRolls.mweapon(l,d,l.mfa_range);var h=$.parseJSON(j);g=collect(g,h)}c.push(l);b.push(g)});if(c.length>1){var f=false;$.each(c,function(g,h){if(h.wlight=="1"&&h.mfa_class_mult=="0.50"){f=true}});$.each(c,function(g,k){var j=hasFeat(d,"Two-Weapon Fighting")||hasFeat(d,"Multiweapon Fighting");var h=0;if(k.mfa_class_mult=="1.00"){h=-6;if(j){h+=2}if(f){h+=2}b[g]["Multiweapon Penalty (Primary)"]=h}else{h=-10;if(j){h+=6}if(f){h+=2}b[g]["Multiweapon Penalty (Secondary)"]=h}})}return JSON.stringify(b)},mattack:function(h,g){var e={};e.Base="1d20";if(hasWeaponFocus(h,g)){e["Weapon Focus"]=1}var b=parseInt($("#"+g+"_bab").attr("data-base-value"));if(b!=0){e.BAB=b}var f=$("#"+g+"_size").attr("data-base-value");var a=sizeModifier(f);if(a!=0){e["Size ("+f+")"]=a}if(h.is_strictly_melee=="0"){if(hasFeat(g,"Weapon Finesse")){var d=get_bonus(parseInt($("#"+g+"_dex").attr("data-base-value")));e["DEX Mod"]=d}else{var c=get_bonus(parseInt($("#"+g+"_str").attr("data-base-value")));if(c!=0){e["STR Mod"]=c}}}else{var d=get_bonus(parseInt($("#"+g+"_dex").attr("data-base-value")));if(d!=0){e["DEX Mod"]=d}}return JSON.stringify(e)},mweapon:function(e,g,f){var h={};h.Base="1d20";if(hasWeaponFocus(e,g)){h["Weapon Focus"]=1}var d=parseInt($("#"+g+"_bab").attr("data-base-value"));if(d!=0){h.BAB=d}var j=$("#"+g+"_size").attr("data-base-value");var a=sizeModifier(j);if(a!=0){h["Size ("+j+")"]=a}if(f=="0"){if(hasFeat(g,"Weapon Finesse")){var b=get_bonus(parseInt($("#"+g+"_dex").attr("data-base-value")));h["DEX Mod"]=b}else{var i=get_bonus(parseInt($("#"+g+"_str").attr("data-base-value")));if(i!=0){h["STR Mod"]=i}}if(e.wname.indexOf("Javelin")!=-1){h.Javelin=-4}}else{if(e.wname.toLowerCase().indexOf("composite")!=-1){var c=parseFloat(e.max_str_mod)||0;if(i<c){h["Composite Proficiency"]=-2}}var b=get_bonus(parseInt($("#"+g+"_dex").attr("data-base-value")));if(b!=0){h["DEX Mod"]=b}}return JSON.stringify(h)},mspatk:function(f,e,b){var d={};d.Base="1d20";if(b=="0"){var a=get_bonus(parseInt($("#"+e+"_str").attr("data-base-value")));if(a!=0){d["STR Mod"]=a}}else{var c=get_bonus(parseInt($("#"+e+"_dex").attr("data-base-value")));if(c!=0){d["DEX Mod"]=c}}return JSON.stringify(d)}};var mainStat={mattack:function(a){return a.aname},mskill:function(a){return a.name},mweapon:function(a){return a.wname},mspatk:function(a){return a.name},mfatk:function(a){return formatting.mfatk(a)}};