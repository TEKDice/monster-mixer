function hasFeat(b,a){return hasNeedle(b,"mfeat",a,"times-taken")}function fullFeatName(b,a){return hasNeedle(b,"mfeat",a,"full-name")}function hasSkill(b,a){return hasNeedle(b,"mskill",a)}function hasQuality(b,a){return hasNeedle(b,"mqualit",a)}function hasNeedle(f,d,e,c){var b=$("#"+f+"_"+d+"_table");var a=false;b.find("td a").each(function(){if($(this).text().indexOf(e)!=-1){if(c!=null){a=$(this).closest("tr").attr("data-"+c)}else{a=true}return}});return a}function modifyHp(uid,mod,notLog){if(mod==0){return}var curHp=parseInt($("#"+uid+"_hp").children(".hp_val").text());var newHp=eval(curHp+mod);$("#"+uid+"_hp").children(".hp_val").text(newHp);var $monsterNode=$("[href=#"+uid+"]");var monsterName=$monsterNode.html();var maxHp=parseInt($("#"+uid+"_hp").attr("data-initial-roll"))+parseInt($("#"+uid+"_hp").attr("data-mod-value"));var text=$("#"+uid+"_hp").children(".hp_val").attr("data-original-title");if(text.indexOf("Modification")!=-1){var newText="";text=text.split("<br>");$.each(text,function(i,e){if(e.indexOf("Modification")!=-1){if((curHp+mod)==maxHp){return}var newMod=parseInt(e.split(" ")[1]);newText+="Modification: "+(mod+newMod)}else{newText+=e}if(i!=text.length-1){newText+="<br>"}});$("#"+uid+"_hp").children(".hp_val").attr("data-original-title",newText)}else{$("#"+uid+"_hp").children(".hp_val").attr("data-original-title",text+"<br>Modification: "+(maxHp-curHp+mod))}var hpPerc=Math.round((newHp/maxHp)*100);if(hpPerc<15){$monsterNode.attr("class","hp-critical")}else{if(hpPerc<50){$monsterNode.attr("class","hp-warning")}else{$monsterNode.attr("class","hp-good")}}if(!notLog){addToLog(monsterName+(mod<0?" lost ":" gained ")+Math.abs(mod)+" hp. ("+newHp+"/"+maxHp+") ["+hpPerc+"%]")}saveMonsters();if(newHp<=0){bootbox.confirm("It looks like "+$monsterNode.text()+" has died. Would you like to mark it as 'killed'?",function(result){if(result){remove(uid,true)}})}}function rollHp(f,d,a,b){$("[href='#"+f+"']").addClass("hp-good");var i=$("#"+f+"_hp");var h="";a=parseInt(a);if(a==0){a=1}h+=i.attr("data-base-value")+": "+a+"<br>";var e;if(e=hasFeat(f,"Toughness")){e=3*parseInt(e);h+="Toughness: "+e+"<br>"}var c=get_bonus(parseInt($("#"+f+"_con").text()))*parseInt(i.attr("data-base-value").split("d")[0]);if(c!=0){h+="CON Modifier: "+c+"<br>"}h=h.slice(0,-4);i.attr("data-initial-roll",a);a+=c;a+=e;i.attr("data-mod-value",c+e);$("#"+f+"_hp").children(".hp_val").text(a);var g=$("#"+f+"_hp").children(".hp_val").attr("data-original-title");if(b||(typeof g!=="undefined"&&g!==false)){$("#"+f+"_hp").children(".hp_val").attr("data-original-title",h)}else{$("#"+f+"_hp").children(".hp_val").attr("rel","tooltip").attr("title",h)}$("#"+f+"_hp").children(".hp_val").tooltip({html:true,placement:"bottom"})}function rollInit(a){var b=parseInt(rollExpression("1d20"));var c=a.attr("data-uid");_rollInit(c,b);sortMonsters()}function _rollInit(d,c){var a=$("#"+d+"_init");var f="";f+="1d20: "+c+"<br>";var e=get_bonus(parseInt($("#"+d+"_dex").attr("data-base-value")));f+="Modifier: "+e+"<br>";var b=0;if(b=hasFeat(a.attr("data-uid"),"Improved Initiative")){b=4*parseInt(b);f+="Improved Initiative: "+b+"<br>"}a.attr("data-initial-value",c);a.text(e+c+b);a.attr("rel","tooltip").attr("title",f).attr("data-original-title",f);a.tooltip({html:true,placement:"bottom"})}function remove(c,b){var a=$("#monsterList a[href=#"+c+"]");var e=parseInt(a.find(".logCount").text());a.parent().remove();$(".tab-pane[data-for='"+c+"']").remove();$("[data-nice-uid='"+c+"']").remove();$("#"+c+"_log").remove();var d=0;$("#monsterList li").each(function(f,g){d++});if(e==1&&d!=0){$("#monsterList li a").first().tab("show")}else{if(d>0){$("#monsterList li:nth-child("+(e-1)+")").find("a").tab("show")}else{if(b){$("#winAlert").show()}else{$("#genAlert").show()}$("#monsterList").hide()}}saveMonsters();updateLogNumbers(c,b)}function updateLogNumbers(b,a){$("#allInfo div p span.logCount").each(function(f,g){var d=$(this).closest("[data-uid]").attr("data-uid");if($(this).text()=="DEAD"||$(this).text()=="GONE"){}var c=$("#monsterList a[href='#"+d+"']");if(c.length==0){$(this).text(a?"DEAD":"GONE")}else{0}})};