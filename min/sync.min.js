var SESSIONS_VARIABLE="sessions";var LAST_SESSION_VARIABLE="lastSessionId";var hasReloadedSession=false;function saveMonsters(){if(!loggedIn){return}if(!currentSessionId){return}var a=[];$("#monsterList li a").each(function(c,f){var b=$(this).attr("data-uid");var d={id:$("#"+b+"_id").text(),curHp:$("#"+b+"_hp .hp_val").text(),maxHp:$("#"+b+"_hp").attr("data-initial-roll"),init:$("#"+b+"_init").attr("data-initial-value")};if(d.id==""){return}a.push(d)});Data.setVar("monsters_"+currentSessionId,a);saveSession(false)}function loadMonsters(a){if(!loggedIn){return}$("#overlay").fadeIn();var b=[];$.each(a,function(c,d){b.push(d.id)});$.post("ajax.php",{action:"gen",ids:JSON.stringify(b)},function(d){var c=$.parseJSON(d);$.eachAsync(c,{loop:function(f,g){setTimeout(function(){var i=g;var h=addNewMonster(i);setupGrids(h);var e=a[f];rollHp(h,null,e.maxHp,true);modifyHp(h,parseInt(e.curHp)-parseInt($("#"+h+"_hp .hp_val").text()),true);_rollInit(h,parseInt(e.init));saveMonsters()},1)},end:function(){$("#overlay").fadeOut()}})})}function removeAllMonsters(){$("#allInfo").empty();$("#monsterList").empty();$("#monsterData .tab-pane").remove()}var currentSessionId;function startSession(){if(!loggedIn){return}currentSessionId=now();saveSession(false)}function loadSession(b){if(!loggedIn){return}removeAllMonsters();currentSessionId=b;var a=Data.getVar("monsters_"+b);loadMonsters(a)}function startNewSession(){if(!loggedIn){return}if(!currentSessionId){return}saveSession(false);removeAllMonsters();startSession()}function deleteSession(a){if(!loggedIn){return}if(!currentSessionId){return}Data.clearVar("monsters_"+a)}function saveSession(b,a){if(!loggedIn){return}if(!currentSessionId){return}Data.setVar(LAST_SESSION_VARIABLE,currentSessionId);if(!Data.hasVar(SESSIONS_VARIABLE)){Data.setVar(SESSIONS_VARIABLE,{})}var c=Data.getVar(SESSIONS_VARIABLE);if(b&&!c.hasOwnProperty(_currentSessionId())){bootbox.confirm("Would you like to save this new session?",function(d){if(!d){return}saveNewSession()})}if(c.hasOwnProperty(_currentSessionId())){if(a){c[_currentSessionId()]=a}c[_currentSessionId()].lastUpdate=now()}else{if(a){c[_currentSessionId()]=a}else{c[_currentSessionId()]=saveNewSession()}c[_currentSessionId()].lastUpdate=now()}Data.setVar(SESSIONS_VARIABLE,c)}function saveNewSession(){var b=Data.getVar(SESSIONS_VARIABLE);var a=b[_currentSessionId()]={startTime:currentSessionId,name:"Nameless Campaign",lastUpdate:now()};Data.setVar(SESSIONS_VARIABLE,b);return a}function hasPreviousSession(){if(!loggedIn){return}if(!Data.hasVar(LAST_SESSION_VARIABLE)){return false}var a=Data.getVar(LAST_SESSION_VARIABLE);if(!Data.hasVar("monsters_"+a)){return false}var b=Data.getVar("monsters_"+a);if(b.length==0){return false}return true}function getPreviousSession(){if(!loggedIn){return}if(!Data.hasVar(LAST_SESSION_VARIABLE)){return null}return Data.getVar(LAST_SESSION_VARIABLE)}function getCurrentSession(){var a=Data.getVar(SESSIONS_VARIABLE);return a[_currentSessionId()]}function getSessionById(b){var a=Data.getVar(SESSIONS_VARIABLE);return a[b]}function sessionManagement(){if(!loggedIn){return}if(hasPreviousSession()){bootbox.confirm("It looks like you had a session open. Would you like to reload it?",function(a){if(hasReloadedSession){return}if(!a){startSession();return}hasReloadedSession=true;loadSession(getPreviousSession())})}else{startSession()}}function _currentSessionId(){return currentSessionId.toString()}function now(){return new Date().getTime()}function changeStatus(a){switch(a){case"ok":updateTextIcon("icon-ok","Ready");return;case"syncing":updateTextIcon("icon-refresh","Syncing...");return;case"noconnection":updateTextIcon("icon-warning-sign","No connection");return}}function updateTextIcon(a,b){$("#noChangeColor").attr("class","").addClass(a);$("#statusText").text(b)};