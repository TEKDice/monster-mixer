var monsterCount=0;function addNewMonster(i){$(".alert").hide();$("#monsterList").show();var g=new Date().getTime();var h=$("<li/>");var c=$("<a/>",{href:"#"+g}).html("[<span class='logCount'>"+(++monsterCount)+"</span>] "+i.data[0].name).attr("data-toggle","tab").attr("data-uid",g);c.appendTo(h);var a=$("#dummyData").html();$("#monsterData").append(a);var f=$(".tab-pane[data-for='none']").not("#dummyData > [data-for='none']");f.attr("id",g);f.attr("data-for",g);addDataToMonster(f,i,g);addFullAttacksToMonster(i,g);var d=$("#monsterList").niceScroll({horizrailenabled:false,zindex:9,railoffset:{left:-118}});$("#monsterList").css("overflow","hidden");tabChangeScrollbars();rollableRowHighlighting(f);setupRollables(f);limitFeatNums(g);var e=$("#dummyLog").html();$("#curMon").append(e);var b=$(".log[data-for='none']").not("#dummyLog > [data-for='none']");b.attr("id",g+"_log").attr("data-for",g);h.appendTo($("#monsterList"));c.tab("show");_hidePopup();saveMonsters();return g}function addFullAttacksToMonster(b,a){}function sortMonsters(){var b=$("#monsterList");var a=b.children("li").get();a.sort(function(d,c){var f=parseInt($("#"+$(d).children("a").attr("data-uid")+"_init").text());var e=parseInt($("#"+$(c).children("a").attr("data-uid")+"_init").text());return e-f});$.each(a,function(c,d){b.append(d)})}function buildACInfo(a){console.log(a);return"test"}function addDataToMonster(f,d,c){var a=d.data[0];f.find("*[id*='1A']").each(function(){var i=$(this).attr("data-attr");$(this).attr("id",$(this).attr("id").replace("1A",c));$(this).attr("data-uid",c);if(a.hasOwnProperty(i)){var k=a[i]=="0"&&$(this).hasClass("dashable")?"--":a[i]+($(this).hasClass("ftable")?"ft":"");if(i=="cr"){if(a[i]<1){switch(a[i]){case"0.25":$(this).html($("<div/>").html("&frac14;").text());break;case"0.33":$(this).html($("<div/>").html("&frac13;").text());break;case"0.50":$(this).html($("<div/>").html("&frac12;").text());break}}else{$(this).text(parseInt(a[i]))}}else{if(i=="ac"||i.indexOf("_ac")!=-1){var j=$("<a/>").text(k).attr("href","#").attr("rel","tooltip").addClass("has-tooltip reg-has-tt").attr("title",buildACInfo(a[i]));$(this).append(j);manualTooltip(j)}else{$(this).text(k)}}$(this).attr("data-base-value",$(this).text());determineRoll($(this))}});f.find(".stats tr").each(function(){var j=$(this).children("td").eq(1).text();var i=get_bonus(j);$(this).children("td").eq(1).text(j+(j!="--"?" ("+(i<0?i:"+"+i)+")":""));$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text())});f.find(".cstats tr").each(function(){var i=parseInt($(this).children("td").eq(1).text());$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text().trim())});for(var h in d){if(h!="data"&&isNaN(parseInt(h))){var b=$("#"+c+"_"+h+"_table");if(b.length==0||d[h].length==0){continue}appendToTable(b,a.name,h,d[h]);b.append("<tr class='loaded' style='display: none;'></tr>")}}var e=a.size+" "+a.category;if(d.msubcat.length>0){var g=[];$.each(d.msubcat,function(j,k){g.push(k.subcategory)});if(g.length>0){e+=" ("+g.join(", ")+")"}}$("#"+c+"_name").attr("title",e).tooltip();setUpHp(f,c);rollInit($("#"+c+"_init"))}function setUpHp(d,a){$hpNode=d.find("span[data-attr='hit_dice']");var c=$hpNode.attr("data-initial-roll");$hpNode.text("");$hpNode.append("<span class='hp_val' data-for='hp'></span>");rollHp(a,$hpNode,c);$hpNode.append('<i id="health_'+a+'" class="icon-heart"></i>');var b=$("#dummyModifiable").html();b=b.split("1A").join(a);$("#health_"+a).popover({html:true,placement:"bottom",content:b,title:"Modify HP"}).click(function(){$(".modify-hp").click(function(){var e=$(this).attr("data-uid");var f=parseInt($("#"+e+"_hp_mod").val());if($(this).hasClass("subtract")){modifyHp(e,-f)}else{modifyHp(e,f)}})})}function appendToTable(c,e,b,a){if(b!="mmove"){c.empty()}var d=c.attr("data-uid");$.each(a,function(g,j){if(((b=="mskill"||b=="mfeat"||b=="mqualit")&&j.name.indexOf("No ")!=-1)||(b=="mattack"&&j.aname.indexOf("No ")!=-1)){c.append('<tr class="no-data"><td>None</td></tr>');return}if(j.hasOwnProperty("is_melee")&&j.hasOwnProperty("is_ranged")&&j.hasOwnProperty("wname")&&j.is_melee=="1"&&j.is_ranged!="0"){var h=j.wname.trim();var f=j.is_ranged;j.wname=h+" (Melee)";j.is_ranged="0";_createRow(c,e,b,a,g,j,d);j.is_ranged=f;j.is_melee="0";j.wname=h+" (Ranged)";_createRow(c,e,b,a,g,j,d)}else{_createRow(c,e,b,a,g,j,d)}});c.find("td.has-tooltip").each(function(){var f=$(this).text().trim();$(this).text("");$(this).prepend('<i class="icon-bookmark"></i><a href="#" rel="tooltip" title="'+$(this).attr("data-desc")+'">'+f+"</a>");manualTooltip($(this).find("a"))})}function manualTooltip(a){a.tooltip({html:true,placement:"bottom",trigger:"manual"});a.click(function(){var c=$(this);var b=true;$(".in").each(function(){if($(this).siblings("a").is(c)){b=false}$(this).siblings("a").tooltip("hide")});if(b){$(this).tooltip("show")}})}function _createRow(h,o,p,b,q,l,g){var u=$("<tr/>");u.appendTo(h);if(p=="mfeat"){u.attr("data-times-taken",l.feat_level);u.attr("data-full-name",l.name)}var m="";var f="";if(rollable.hasOwnProperty(p)){u.attr("data-roll","0");$("#"+g+"_"+p+"_table .loaded").livequery(function(){var i=rollable[p](l,g,m,f);if(i!="{}"){u.attr("data-roll",i)}else{u.unbind()}});var n=mainStat[p](l);if(n.indexOf(o)!=-1){n=n.substring(o.length).trim()}u.attr("data-roll-for",n);if(p=="mweapon"||p=="mattack"||p=="mspatk"){if(l.spatk!=null&&l.spatk.indexOf(o)!=-1){l.spatk=l.spatk.substring(o.length+1)}u.attr("data-spatk",l.spatk);m=l.is_ranged;f=l.is_melee;u.attr("data-range",m);var k=0;if(l.hasOwnProperty("critical")){if(l.critical.indexOf("-")!=-1){var j=l.critical.split("-");u.attr("data-crit-mult",j[1].split("x")[1]);k=parseInt(j[0])}else{if(l.critical=="0"){k=20;u.attr("data-crit-mult",2)}else{if(l.critical.indexOf("x")!=-1){k=20;u.attr("data-crit-mult",l.critical.substring(1))}else{console.warn("critical wasn't parseable: "+l.critical);console.warn(l)}}}}$("#"+g+"_"+p+"_table .loaded").livequery(function(){if(hasFeat(g,"Improved Critical")){var v=fullFeatName(g,"Improved Critical");var i=v.substring(v.indexOf("(")+1,v.indexOf(")"));if(l.aname!=undefined){if(i.toLowerCase()==l.aname.toLowerCase()){k=21-((20-k+1)*2)}}if(l.wname!=undefined){if(i.toLowerCase()==l.wname.toLowerCase()){k=21-((20-k+1)*2)}}}u.attr("data-min-crit",k)})}}if(attackRolls.hasOwnProperty(p)&&(l.class_mult!=null||p=="mspatk"||p=="mfatk")){u.attr("data-attack-roll","0");$("#"+g+"_"+p+"_table .loaded").livequery(function(){u.attr("data-attack-roll",attackRolls[p](l,g,m))})}u.attr("data-how-many","1");if(attackRolls.hasOwnProperty(p)&&l.how_many!=null){u.attr("data-how-many",l.how_many)}if(p=="mfatk"){var s=[],d=[],r=[],c=[],a=[],e=[];$.each(l,function(w,y){if(y.spatkname!=null&&y.spatkname.indexOf(o)!=-1){y.spatkname=y.spatkname.substring(o.length+1)}e.push(parseInt(y.is_uses_bab));s.push(y.spatkname);if(y.wir){d.push(y.wir)}else{d.push(y.mfa_range)}var v=0;y.critical=y.atkct|y.wct;if(!y.critical){y.critical="0"}y.how_many=y.atkhm|y.whm;if(!y.how_many){y.how_many="1"}a.push(y.how_many);if(y.hasOwnProperty("critical")){if(y.critical.indexOf("-")!=-1){var x=y.critical.split("-");r.push(x[1].split("x")[1]);v=parseInt(x[0])}else{if(y.critical=="0"){v=20;r.push(2)}else{if(y.critical.indexOf("x")!=-1){v=20;r.push(y.critical.substring(1))}else{console.warn("critical wasn't parseable: "+y.critical);console.warn(l)}}}}$("#"+g+"_"+p+"_table .loaded").livequery(function(){if(hasFeat(g,"Improved Critical")){var z=fullFeatName(g,"Improved Critical");var i=z.substring(z.indexOf("(")+1,z.indexOf(")"));if(y.aname!=undefined){if(i.toLowerCase()==y.aname.toLowerCase()){v=21-((20-v+1)*2)}}if(y.wname!=undefined){if(i.toLowerCase()==y.wname.toLowerCase()){v=21-((20-v+1)*2)}}}c.push(v);u.attr("data-min-crit",JSON.stringify(c))})});u.attr("data-spatk",JSON.stringify(s));u.attr("data-range",JSON.stringify(d));u.attr("data-crit-mult",JSON.stringify(r));u.attr("data-how-many",JSON.stringify(a));u.attr("data-bab-use",JSON.stringify(e));l.descript=getFullAttackInfo(l)}var t=formatting[p](l);if(t.indexOf(o)!=-1){t=t.substring(o.length+1)}u.append("<td"+(l.hasOwnProperty("descript")?" class='has-tooltip' data-desc='"+l.descript.split("\n").join("<br>")+"'":"")+">"+t+"</td>")}function getFullAttackInfo(b){var a="";$.each(b,function(c,d){a+=(d.wname||d.aname)+": "+(d.whd||d.atkhd)+"<br>"});return a};