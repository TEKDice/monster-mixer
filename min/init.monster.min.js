var monsterCount=0;var tempMon;function addNewMonster(i){$(".alert").hide();$("#monsterList").show();var g=new Date().getTime();var h=$("<li/>");var c=$("<a/>",{href:"#"+g}).html("[<span class='logCount'>"+(++monsterCount)+"</span>] "+i.data[0].name).attr("data-toggle","tab").attr("data-uid",g);c.appendTo(h);var a=$("#dummyData").html();$("#monsterData").append(a);var f=$(".tab-pane[data-for='none']").not("#dummyData > [data-for='none']");f.attr("id",g);f.attr("data-for",g);addDataToMonster(f,i,g);addFullAttacksToMonster(i,g);var d=$("#monsterList").niceScroll({horizrailenabled:false,zindex:9,railoffset:{left:-118}});$("#monsterList").css("overflow","hidden");tabChangeScrollbars();rollableRowHighlighting(f);setupRollables(f);limitFeatNums(g);var e=$("#dummyLog").html();$("#curMon").append(e);var b=$(".log[data-for='none']").not("#dummyLog > [data-for='none']");b.attr("id",g+"_log").attr("data-for",g);h.appendTo($("#monsterList"));c.tab("show");_hidePopup();saveMonsters();return g}function addFullAttacksToMonster(b,a){}function sortMonsters(){var b=$("#monsterList");var a=b.children("li").get();a.sort(function(d,c){var f=parseInt($("#"+$(d).children("a").attr("data-uid")+"_init").text());var e=parseInt($("#"+$(c).children("a").attr("data-uid")+"_init").text());return e-f});$.each(a,function(c,d){b.append(d)})}function buildACInfo(b,a){var c;switch(a){case"ac":c=getAc(b);break;case"flatfoot_ac":c=getFlatac(b);break;case"touch_ac":c=getTouchac(b);break}if(c==null){return""}return _arrToTooltip(c)}function addDataToMonster(f,d,c){var a=d.data[0];f.find("*[id*='1A']").each(function(){var i=$(this).attr("data-attr");$(this).attr("id",$(this).attr("id").replace("1A",c));$(this).attr("data-uid",c);if(a.hasOwnProperty(i)){var k=a[i]=="0"&&$(this).hasClass("dashable")?"--":a[i]+($(this).hasClass("ftable")?"ft":"");if(i=="cr"){if(a[i]<1){switch(a[i]){case"0.25":$(this).html($("<div/>").html("&frac14;").text());break;case"0.33":$(this).html($("<div/>").html("&frac13;").text());break;case"0.50":$(this).html($("<div/>").html("&frac12;").text());break}}else{$(this).text(parseInt(a[i]))}}else{if(i=="ac"||i.indexOf("_ac")!=-1){var j=$("<a/>").text(k).attr("href","#").attr("rel","tooltip").addClass("has-tooltip reg-has-tt").attr("title",buildACInfo(d,i));$(this).append(j);manualTooltip(j)}else{$(this).text(k)}}$(this).attr("data-base-value",$(this).text());determineRoll($(this))}});f.find(".stats tr").each(function(){var j=$(this).children("td").eq(1).text();var i=get_bonus(j);$(this).children("td").eq(1).text(j+(j!="--"?" ("+(i<0?i:"+"+i)+")":""));$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text())});f.find(".cstats tr").each(function(){var i=parseInt($(this).children("td").eq(1).text());$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text().trim())});for(var h in d){if(h!="data"&&isNaN(parseInt(h))){var b=$("#"+c+"_"+h+"_table");if(b.length==0||d[h].length==0){continue}appendToTable(b,a.name,h,d[h]);b.append("<tr class='loaded' style='display: none;'></tr>")}}var e=a.size+" "+a.category;if(d.msubcat.length>0){var g=[];$.each(d.msubcat,function(j,k){g.push(k.subcategory)});if(g.length>0){e+=" ("+g.join(", ")+")"}}$("#"+c+"_name").attr("title",e).tooltip();setUpHp(f,c);rollInit($("#"+c+"_init"))}function setUpHp(d,a){$hpNode=d.find("span[data-attr='hit_dice']");var c=$hpNode.attr("data-initial-roll");$hpNode.text("");$hpNode.append("<span class='hp_val' data-for='hp'></span>");rollHp(a,$hpNode,c);$hpNode.append('<i id="health_'+a+'" class="icon-heart"></i>');var b=$("#dummyModifiable").html();b=b.split("1A").join(a);$("#health_"+a).popover({html:true,placement:"bottom",content:b,title:"Modify HP"}).click(function(){$(".modify-hp").click(function(){var e=$(this).attr("data-uid");var f=parseInt($("#"+e+"_hp_mod").val());if($(this).hasClass("subtract")){modifyHp(e,-f)}else{modifyHp(e,f)}})})}function appendToTable(c,e,b,a){if(b!="mmove"){c.empty()}var d=c.attr("data-uid");$.each(a,function(h,k){if(((b=="mskill"||b=="mfeat"||b=="mqualit")&&k.name.indexOf("No ")!=-1)||(b=="mattack"&&k.aname.indexOf("No ")!=-1)){c.append('<tr class="no-data"><td>None</td></tr>');return}if(k.hasOwnProperty("is_melee")&&k.hasOwnProperty("is_ranged")&&k.hasOwnProperty("wname")&&k.is_melee=="1"&&k.is_ranged!="0"){var j=k.wname.trim();var f=k.is_ranged;k.wname=j+" (Melee)";k.is_ranged="0";_createRow(c,e,b,a,h,k,d);k.is_ranged=f;k.is_melee="0";k.wname=j+" (Ranged)";_createRow(c,e,b,a,h,k,d)}else{if(k.hasOwnProperty("is_multi_handed")&&k.is_multi_handed=="1"){var j=k.wname.trim();k.is_one_handed="1";k.wname=j+" (1H)";_createRow(c,e,b,a,h,k,d);var g=jQuery.extend(true,{},k);g.is_one_handed="0";g.wname=j+" (2H)";_createRow(c,e,b,a,h,g,d)}else{_createRow(c,e,b,a,h,k,d)}}});c.find("td.has-tooltip").each(function(){var f=$(this).text().trim();$(this).text("");$(this).prepend('<i class="icon-bookmark"></i><a href="#" rel="tooltip" title="'+$(this).attr("data-desc")+'">'+f+"</a>");manualTooltip($(this).find("a"))})}function manualTooltip(a){a.tooltip({html:true,placement:"bottom",trigger:"manual"});a.click(function(){var c=$(this);var b=true;$(".in").each(function(){if($(this).siblings("a").is(c)){b=false}$(this).siblings("a").tooltip("hide")});if(b){$(this).tooltip("show")}})}function _createRow(j,p,q,b,r,m,h){var v=$("<tr/>");v.appendTo(j);if(q=="mfeat"){v.attr("data-times-taken",m.feat_level);v.attr("data-full-name",m.name)}var n="";var f="";if(rollable.hasOwnProperty(q)){v.attr("data-roll","0");$("#"+h+"_"+q+"_table .loaded").livequery(function(){var i=rollable[q](m,h,n,f);if(i!="{}"){v.attr("data-roll",i)}else{v.unbind()}});var o=mainStat[q](m);if(o.indexOf(p)!=-1){o=o.substring(p.length).trim()}v.attr("data-roll-for",o);if(q=="mweapon"||q=="mattack"||q=="mspatk"){if(m.spatk!=null&&m.spatk.indexOf(p)!=-1){m.spatk=m.spatk.substring(p.length+1)}v.attr("data-spatk",m.spatk);n=m.is_ranged;f=m.is_melee;v.attr("data-range",n);var l=0;if(m.hasOwnProperty("critical")){if(m.critical.indexOf("-")!=-1){var k=m.critical.split("-");v.attr("data-crit-mult",k[1].split("x")[1]);l=parseInt(k[0])}else{if(m.critical=="0"){l=20;v.attr("data-crit-mult",2)}else{if(m.critical.indexOf("x")!=-1){l=20;v.attr("data-crit-mult",m.critical.substring(1))}else{console.warn("critical wasn't parseable: "+m.critical);console.warn(m)}}}}$("#"+h+"_"+q+"_table .loaded").livequery(function(){if(hasFeat(h,"Improved Critical")){var w=fullFeatName(h,"Improved Critical");var i=w.substring(w.indexOf("(")+1,w.indexOf(")"));if(m.aname!=undefined){if(i.toLowerCase()==m.aname.toLowerCase()){l=21-((20-l+1)*2)}}if(m.wname!=undefined){if(i.toLowerCase()==m.wname.toLowerCase()){l=21-((20-l+1)*2)}}}v.attr("data-min-crit",l)})}}if(attackRolls.hasOwnProperty(q)&&(m.class_mult!=null||q=="mspatk"||q=="mfatk")){v.attr("data-attack-roll","0");$("#"+h+"_"+q+"_table .loaded").livequery(function(){v.attr("data-attack-roll",attackRolls[q](m,h,n))})}v.attr("data-how-many","1");if(attackRolls.hasOwnProperty(q)&&m.how_many!=null){v.attr("data-how-many",m.how_many)}if(q=="mfatk"){var t=[],d=[],s=[],c=[],a=[],e=[],g=[];$.each(m,function(x,z){if(z.spatkname!=null&&z.spatkname.indexOf(p)!=-1){z.spatkname=z.spatkname.substring(p.length+1)}e.push(parseInt(z.is_uses_bab));t.push(z.spatkname);g.push(z.mfa_class_mult=="0.50"?1:0);if(z.wir){d.push(z.wir)}else{d.push(z.mfa_range)}var w=0;z.critical=z.atkct|z.wct;if(!z.critical){z.critical="0"}z.how_many=z.atkhm|z.whm;if(!z.how_many){z.how_many="1"}a.push(z.how_many);if(z.hasOwnProperty("critical")){if(z.critical.indexOf("-")!=-1){var y=z.critical.split("-");s.push(y[1].split("x")[1]);w=parseInt(y[0])}else{if(z.critical=="0"){w=20;s.push(2)}else{if(z.critical.indexOf("x")!=-1){w=20;s.push(z.critical.substring(1))}else{console.warn("critical wasn't parseable: "+z.critical);console.warn(m)}}}}$("#"+h+"_"+q+"_table .loaded").livequery(function(){if(hasFeat(h,"Improved Critical")){var A=fullFeatName(h,"Improved Critical");var i=A.substring(A.indexOf("(")+1,A.indexOf(")"));if(z.aname!=undefined){if(i.toLowerCase()==z.aname.toLowerCase()){w=21-((20-w+1)*2)}}if(z.wname!=undefined){if(i.toLowerCase()==z.wname.toLowerCase()){w=21-((20-w+1)*2)}}}c.push(w);v.attr("data-min-crit",JSON.stringify(c))})});v.attr("data-spatk",JSON.stringify(t));v.attr("data-range",JSON.stringify(d));v.attr("data-crit-mult",JSON.stringify(s));v.attr("data-how-many",JSON.stringify(a));v.attr("data-bab-use",JSON.stringify(e));v.attr("data-secondary",JSON.stringify(g));m.descript=getFullAttackInfo(m)}var u=formatting[q](m);if(u.indexOf(p)!=-1){u=u.substring(p.length+1)}v.append("<td"+(m.hasOwnProperty("descript")?" class='has-tooltip' data-desc='"+m.descript.split("\n").join("<br>")+"'":"")+">"+u+"</td>")}function getFullAttackInfo(b){var a="";$.each(b,function(c,d){a+=(d.wname||d.aname)+": "+(d.whd||d.atkhd)+"<br>"});return a};