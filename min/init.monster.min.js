var monsterCount=0;var tempMon;function addNewMonster(i){$(".alert").hide();$("#monsterList").show();var g=new Date().getTime();var h=$("<li/>");var c=$("<a/>",{href:"#"+g}).html("[<span class='logCount'>"+(++monsterCount)+"</span>] "+i.data[0].name).attr("data-toggle","tab").attr("data-uid",g);c.appendTo(h);c.attr("class","hp-good");var a=$("#dummyData").html();$("#monsterData").append(a);var f=$(".tab-pane[data-for='none']").not("#dummyData > [data-for='none']");f.attr("id",g);f.attr("data-for",g);addDataToMonster(f,i,g);var d=$("#monsterList").niceScroll({horizrailenabled:false,zindex:9,railoffset:{left:-118}});$("#monsterList").css("overflow","hidden");tabChangeScrollbars();rollableRowHighlighting(f);setupRollables(f);limitFeatNums(g);var e=$("#dummyLog").html();$("#curMon").append(e);var b=$(".log[data-for='none']").not("#dummyLog > [data-for='none']");b.attr("id",g+"_log").attr("data-for",g);h.appendTo($("#monsterList"));c.tab("show");_hidePopup();sortMonsters();saveMonsters();return g}function sortMonsters(){var b=$("#monsterList");var a=b.children("li").get();a.sort(function(d,c){var f=parseInt($("#"+$(d).children("a").attr("data-uid")+"_init").text());var e=parseInt($("#"+$(c).children("a").attr("data-uid")+"_init").text());return e-f});$.each(a,function(c,d){b.append(d)})}function buildACInfo(b,a){var c=getACArr(b,a);if(c==null){return""}return _arrToTooltip(c)}function getACArr(b,a){switch(a){case"ac":return getAc(b);break;case"flatfoot_ac":return getFlatac(b);break;case"touch_ac":return getTouchac(b);break;default:return null}return null}function refreshAc(b){var a=$.parseJSON(b.attr("data-ac"));var d=_rollArray(a);b.empty();var c=$("<a/>").text(d.result).attr("href","#").attr("rel","tooltip").addClass("has-tooltip reg-has-tt").attr("title",d.text);b.append(c);manualTooltip(c)}function addDataToMonster(f,d,c){var a=d.data[0];f.find("*[id*='1A']").each(function(){var i=$(this).attr("data-attr");$(this).attr("id",$(this).attr("id").replace("1A",c));$(this).attr("data-uid",c);if(a.hasOwnProperty(i)){var k=a[i]=="0"&&$(this).hasClass("dashable")?"--":a[i]+($(this).hasClass("ftable")?"ft":"");if(i=="cr"){if(a[i]<1){switch(a[i]){case"0.25":$(this).html($("<div/>").html("&frac14;").text());break;case"0.33":$(this).html($("<div/>").html("&frac13;").text());break;case"0.50":$(this).html($("<div/>").html("&frac12;").text());break}}else{$(this).text(parseInt(a[i]))}}else{if(i=="ac"||i.indexOf("_ac")!=-1){$(this).attr("data-ac",JSON.stringify(getACArr(d,i)));refreshAc($(this))}else{if(i=="grapple"){var j=$(this);$("#"+c+"_mfeat_table .loaded").livequery(function(){var l=parseInt(k);if(hasFeat(c,"Racial Grapple Bonus")){l+=4}if(hasFeat(c,"Improved Grapple")){l+=4}j.text(l)})}else{$(this).text(k)}}}$(this).attr("data-base-value",$(this).text());determineRoll($(this))}});f.find(".stats tr").each(function(){var j=$(this).children("td").eq(1).text();var i=get_bonus(j);$(this).children("td").eq(1).text(j+(j!="--"?" ("+(i<0?i:"+"+i)+")":""));$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text())});f.find(".cstats tr").each(function(){var i=parseInt($(this).children("td").eq(1).text());$(this).attr("data-roll",JSON.stringify({Base:"1d20",Bonus:i}));$(this).attr("data-roll-for",$(this).children("td").eq(0).text().trim())});for(var h in d){if(h!="data"&&isNaN(parseInt(h))){var b=$("#"+c+"_"+h+"_table");if(b.length==0||d[h].length==0){continue}appendToTable(b,a.name,h,d[h]);b.append("<tr class='loaded' style='display: none;'></tr>")}}var e=a.size+" "+a.category;if(d.msubcat.length>0){var g=[];$.each(d.msubcat,function(j,k){g.push(k.subcategory)});if(g.length>0){e+=" ("+g.join(", ")+")"}}$("#"+c+"_name").attr("title",e).tooltip();setUpHp(f,c);rollInit($("#"+c+"_init"))}function setUpHp(d,a){$hpNode=d.find("span[data-attr='hit_dice']");var c=$hpNode.attr("data-initial-roll");$hpNode.text("");$hpNode.append("<span class='hp_val' data-for='hp'></span>");rollHp(a,$hpNode,c);$hpNode.append('<i id="health_'+a+'" class="icon-heart"></i>');var b=$("#dummyModifiable").html();b=b.split("1A").join(a);$("#health_"+a).popover({html:true,placement:"bottom",content:b,title:"Modify HP"}).click(function(){$(".modify-hp").click(function(){var e=$(this).attr("data-uid");var f=parseInt($("#"+e+"_hp_mod").val());if($(this).hasClass("subtract")){modifyHp(e,-f)}else{modifyHp(e,f)}})})}function appendToTable(c,e,b,a){if(b!="mmove"){c.empty()}var d=c.attr("data-uid");$.each(a,function(h,k){if(k.name=="Racial Grapple Bonus"){return}if(((b=="mskill"||b=="mfeat"||b=="mqualit")&&k.name.indexOf("No ")!=-1)||(b=="mattack"&&k.aname.indexOf("No ")!=-1)){c.append('<tr class="no-data"><td>None</td></tr>');return}if(k.hasOwnProperty("is_melee")&&k.hasOwnProperty("is_ranged")&&k.hasOwnProperty("wname")&&k.is_melee=="1"&&k.is_ranged!="0"){var j=k.wname.trim();var f=k.is_ranged;k.wname=j+" (Melee)";k.is_ranged="0";_createRow(c,e,b,a,h,k,d);k.is_ranged=f;k.is_melee="0";k.wname=j+" (Ranged)";_createRow(c,e,b,a,h,k,d)}else{if(k.hasOwnProperty("is_multi_handed")&&k.is_multi_handed=="1"){var j=k.wname.trim();k.is_one_handed="1";k.wname=j+" (1H)";_createRow(c,e,b,a,h,k,d);var g=jQuery.extend(true,{},k);g.is_one_handed="0";g.wname=j+" (2H)";_createRow(c,e,b,a,h,g,d)}else{_createRow(c,e,b,a,h,k,d)}}});c.find("td.has-tooltip").each(function(){var f=$(this).text().trim();$(this).text("");$(this).prepend('<i class="icon-bookmark"></i><a href="#" rel="tooltip" title="'+$(this).attr("data-desc")+'">'+f+"</a>");manualTooltip($(this).find("a"))})}function manualTooltip(a){a.tooltip({html:true,placement:"bottom",trigger:"manual"});a.click(function(){var c=$(this);var b=true;$(".in").each(function(){if($(this).siblings("a").is(c)){b=false}$(this).siblings("a").tooltip("hide")});if(b){$(this).tooltip("show")}})}function _createRow(m,v,w,b,x,q,l){var B=$("<tr/>");B.appendTo(m);if(w=="mfeat"){B.attr("data-times-taken",q.feat_level);B.attr("data-full-name",q.name)}var r="";var h="";var t=rollable.hasOwnProperty(w)?rollable[w](q,l,r,h):null;var k=attackRolls.hasOwnProperty(w)?attackRolls[w](q,l,r):null;if(t){B.attr("data-roll","0");$("#"+l+"_"+w+"_table .loaded").livequery(function(){if(t!="{}"){B.attr("data-roll",t)}else{B.unbind()}});var s=mainStat[w](q);if(s.indexOf(v)!=-1){s=s.substring(v.length).trim()}B.attr("data-roll-for",s);if(w=="mweapon"||w=="mattack"||w=="mspatk"){if(q.spatk!=null&&q.spatk.indexOf(v)!=-1){q.spatk=q.spatk.substring(v.length+1)}B.attr("data-spatk",q.spatk);r=q.is_ranged;h=q.is_melee;B.attr("data-range",r);var p=0;if(q.hasOwnProperty("critical")){if(q.critical.indexOf("-")!=-1){var o=q.critical.split("-");B.attr("data-crit-mult",o[1].split("x")[1]);p=parseInt(o[0])}else{if(q.critical=="0"){p=20;B.attr("data-crit-mult",2)}else{if(q.critical.indexOf("x")!=-1){p=20;B.attr("data-crit-mult",q.critical.substring(1))}else{console.error("critical wasn't parseable: "+q.critical+" "+q.name)}}}}$("#"+l+"_"+w+"_table .loaded").livequery(function(){if(hasFeat(l,"Improved Critical")){p=21-((20-p+1)*2)}B.attr("data-min-crit",p)})}}if(k&&(q.class_mult!=null||w=="mspatk"||w=="mfatk")){B.attr("data-attack-roll","0");$("#"+l+"_"+w+"_table .loaded").livequery(function(){B.attr("data-attack-roll",k)})}B.attr("data-how-many","1");if(attackRolls.hasOwnProperty(w)&&q.how_many!=null){B.attr("data-how-many",q.how_many)}if(w=="mfatk"){var z=[],f=[],y=[],e=[],a=[],g=[],j=[],d=[],u=[],n=[];$.each(q,function(F,I){if(I.spatkname!=null&&I.spatkname.indexOf(v)!=-1){I.spatkname=I.spatkname.substring(v.length+1)}g.push(parseInt(I.is_uses_bab));z.push(I.spatkname);j.push(I.mfa_class_mult=="0.50"?1:0);if(I.wir){f.push(I.wir)}else{f.push(I.mfa_range)}var H=0;I.critical=I.atkct||I.wct;if(!I.critical){I.critical="0"}I.how_many=I.atkhm||I.whm;if(!I.how_many){I.how_many="1"}u.push(I.wname||I.aname);a.push(I.how_many);if(I.hasOwnProperty("critical")){if(I.critical.indexOf("-")!=-1){var K=I.critical.split("-");y.push(K[1].split("x")[1]);H=parseInt(K[0])}else{if(I.critical=="0"){H=20;y.push(2)}else{if(I.critical.indexOf("x")!=-1){H=20;y.push(I.critical.substring(1))}else{console.error("critical wasn't parseable: "+q.critical+" "+q.name)}}}}$("#"+l+"_mfeat_table .loaded").livequery(function(){if(hasFeat(l,"Improved Critical")){H=21-((20-H+1)*2)}e.push(H);B.attr("data-min-crit",JSON.stringify(e))});if(I.is_uses_bab=="1"){var L=parseInt($("#"+l+"_bab").text());var C=L/5;var D=Math.max(Math.floor(C)+(C>1?1:0),1);var J=1;for(var G=0;G<D;G++){var E={damage:$.parseJSON(k)[F],tohit:$.parseJSON(t)[F],refIndex:F};if(J>1){E.damage["Attack "+(J)]=-(J-1)*5}if(j[F]){if(G==0){d.push(E)}else{if((hasFeat(l,"Greater Two-Weapon Fighting")||hasFeat(l,"Greater Multiweapon Fighting"))&&J==2){d.push(E);J++}else{if((hasFeat(l,"Improved Two-Weapon Fighting")||hasFeat(l,"Improved Multiweapon Fighting"))&&J==1){d.push(E);J++}}}}else{d.push(E);J++}}n.push(J)}else{var E={damage:$.parseJSON(k)[F],tohit:$.parseJSON(t)[F],refIndex:F};for(var G=0;G<a[F];G++){d.push(E)}}});var c={range:f,spatk:z,names:u,critMult:y,howMany:a,atkCt:n,minCrit:e,secondary:j,rolls:d};B.attr("data-fatk",JSON.stringify(c));q.descript=getFullAttackInfo(q)}var A=formatting[w](q);if(A.indexOf(v)!=-1){A=A.substring(v.length+1)}B.append("<td"+(q.hasOwnProperty("descript")?" class='has-tooltip' data-desc='"+q.descript.split("\n").join("<br>")+"'":"")+">"+A+"</td>")}function getFullAttackInfo(b){var a="";$.each(b,function(c,d){a+=(d.wname||d.aname)+": "+(d.whd||d.atkhd)+" x"+(d.how_many)+"<br>"});return a};